---
title: æ¯æ—¥ã®é‹å‹•é‡ã¨ç¡çœ çŠ¶æ…‹ã‚’Twitterã«å‚ã‚Œæµã—ã¦ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹ã€‚
date: 2021-05-23T13:54:10.586Z
description: "fitbit APIã§é‹å‹•æ™‚é–“ã¨ç¡çœ æ™‚é–“ã‚’å–å¾—ã—ã€Twitterã«å‘Ÿãä»•çµ„ã¿ã‚’ä½œæˆã—ãŸã€‚fitbit API, AWS
  Lambda, Secret Managerã‚’ä½¿ç”¨ã—ãŸã€‚ "
---
## ã¯ã˜ã‚ã«

æœ€è¿‘ã€ã“ã®ã‚ˆã†ãªã”æ™‚ä¸–ã§ã‚ã‚‹æ•…ã«ã€åœ¨å®…å‹¤å‹™ã§ä¸€æ­©ã‚‚å¤–ã«å‡ºãªã„æ—¥ã‚‚çã—ããªã„ã€‚
æ„è­˜ã—ãªã„ã¨é‹å‹•ä¸è¶³ã«ãªã‚Šã‹ã­ãªã„ã€‚æœ€è¿‘ã€ä½“ã®å¥åº·ç®¡ç†ã‚’ç›®çš„ã«fitbitã¨ã„ã†ã‚¹ãƒãƒ¼ãƒˆã‚¦ã‚©ãƒƒãƒã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã€‚
ã“ã®fitbitã¯APIãŒå…¬é–‹ã•ã‚Œã¦ãŠã‚Šã€ã‚¹ãƒãƒ¼ãƒˆã‚¦ã‚©ãƒƒãƒã®ã‚¢ãƒ—ãƒªã‚’ä½œæˆã—ãŸã‚Šã€ãƒ‡ãƒã‚¤ã‚¹ã®æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚
ãã“ã§ã€é‹å‹•çŠ¶æ³ã¨ç¡çœ çŠ¶æ…‹ã®ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°ã®ãŸã‚ã€fitbitã§å–å¾—ã—ãŸæƒ…å ±ã‚’æ¯æ—¥ãƒ„ã‚¤ãƒ¼ãƒˆã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

## fitbitã¨ã¯...

fitbitã¨ã¯ã€ã‚¢ãƒ¡ãƒªã‚«ã®fitbit.inc ãŒè²©å£²ã—ã¦ã„ã‚‹ã€ã‚¹ãƒãƒ¼ãƒˆã‚¦ã‚©ãƒƒãƒã§ã‚ã‚‹ã€‚ã“ã‚Œã‚’æ‰‹é¦–ã«è£…ç€ã™ã‚‹ã“ã¨ã§é‹å‹•ä¸­ã®å¿ƒæ‹æ•°ã‚„é…¸ç´ æ¿ƒåº¦ãªã©ã‚’æ¸¬å®šã§ãã‚‹ã€‚ã“ã®ã‚ˆã†ãªæƒ…å ±ã‹ã‚‰ã€é‹å‹•ã«ã‚ˆã‚‹æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ã€å¿ƒæ‹æ•°ã®å¤‰åŒ–ã€ç¡çœ ã®è³ªã®è¨˜éŒ²ãªã©ãŒå¯èƒ½ãªã‚‚ã®ã§ã‚ã‚‹ã€‚ç§ãŒä½¿ç”¨ã—ã¦ã„ã‚‹[Fitbit Versa 3](https://www.fitbit.com/jp/versa3) ã§ã¯ã€ãã‚Œã‚‰ã«åŠ ãˆã¦ã€GPSã§ãƒ¯ãƒ¼ã‚¯ã‚¢ã‚¦ãƒˆã‚’ç®¡ç†ã§ããŸã‚Šã€[å°†æ¥çš„ã«Suicaã«å¯¾å¿œã—ã€éæ¥è§¦æ±ºæ¸ˆç«¯æœ«ã¨ã—ã¦ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ã«ãªã‚‹](https://prtimes.jp/main/html/rd/p/000000038.000018554.html)ãã†ã ã€‚

## fitbitã®APIã«ã¤ã„ã¦...

fitbitã¯APIã§ãƒ‡ãƒã‚¤ã‚¹ã®æƒ…å ±ã‚’å–å¾—ã—ãŸã‚Šã€fitbitå°‚ç”¨ã®ç‹¬è‡ªã‚¢ãƒ—ãƒªã‚’é–‹ç™ºãŒã§ãã‚‹ã‚ˆã†ã«ãªã£ã¦ã„ã‚‹ã€‚ã“ã®APIã‚’ä½¿ãˆã°ã€fitbitã§å–å¾—ã•ã‚Œã¦ã„ã‚‹1æ—¥ã®æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼ã‚„ç¡çœ æ™‚é–“ãªã©ã‚’å–å¾—ã§ãã‚‹ã€‚æ—¢ã«fitbitã‚’åˆ©ç”¨ã—ã¦ã„ã‚‹ã®ã§ã‚ã‚Œã°Swagger UIå½¢å¼ã§ã€[Fitbit Web API](https://dev.fitbit.com/build/reference/web-api/explore/) ã‚’è©¦ã™ã“ã¨ãŒã§ãã‚‹ã€‚ã“ã®APIã¯ã€OAuth2.0ã§ã®èªå¯ã‚’è¦æ±‚ã—ã€èªå¯ã‚’å–å¾—ã§ãã‚Œã°ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ãŒå–å¾—ã§ãã‚‹ã€‚

ClientIDãªã©ãŒè¨˜è¼‰ã•ã‚ŒãŸãƒšãƒ¼ã‚¸ã®ä¸‹éƒ¨ã«ã‚ã‚‹ `OAuth 2.0 tutorial page` ã§å®Ÿéš›ã«è©¦ã™ã“ã¨ãŒã§ãã‚‹ã€‚ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã®æœŸé™ãŒåˆ‡ã‚Œã‚‹ã¨å†åº¦èªå¯å–å¾—ã‹ã‚‰ã‚„ã‚‹å¿…è¦ãŒã‚ã‚Šé¢å€’ã ãŒã€OAuth2.0ã§ã¯ã€æœŸé™å†…ã§ã‚ã‚Œã°ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

## ã©ã†ã‚„ã£ã¦Tweetã™ã‚‹ã‚“ã ã£ã‘ï¼Ÿ

fitbit APIã§å–å¾—ã—ãŸæƒ…å ±ã‚’ãƒ„ã‚¤ãƒ¼ãƒˆã™ã‚‹ãŸã‚ã«ã¯ã€å°‘ãªãã¨ã‚‚ã€ä»¥ä¸‹ã®4ç‚¹ã‚’ã‚¯ãƒªã‚¢ã—ãªã„ã¨ã„ã‘ãªã„ã€‚

1. Twitterã®developerç™»éŒ²ã‚’æ¸ˆã¾ã›ã¦ã€Twitterã®APIã‚’å©ããŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³(ç„¡æœŸé™)ã‚’å–å¾—ã—ã¦ã„ãªã„ã¨ã„ã‘ãªã„ã€‚
2. fitbitã®APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³(æœŸé™ãŒã‚ã‚‹)ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
3. fitbitã®APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®šæœŸçš„ã«æ›´æ–°ã™ã‚‹ä»•çµ„ã¿ãŒã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
4. å®šæœŸçš„ã«fitbitAPIã‚’å©ã„ã¦å–å¾—ã—ãŸå€¤ã‚’ç”¨ã„ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã€Twitterã«æŠ•ç¨¿ã™ã‚‹ä»•çµ„ã¿ãŒå¿…è¦ã«ãªã‚‹ã€‚

> Twitterã®developerç™»éŒ²ã‚’æ¸ˆã¾ã›ã¦ã€Twitterã®APIã‚’å©ããŸã‚ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³(ç„¡æœŸé™)ã‚’å–å¾—ã—ã¦ã„ãªã„ã¨ã„ã‘ãªã„ã€‚

ã«é–¢ã—ã¦ã¯ã€[Twitterã®Developerãƒãƒ¼ã‚¿ãƒ«](https://developer.twitter.com)ã‹ã‚‰ã‚¢ãƒ—ãƒªã®ç™»éŒ²ã¨ãƒˆãƒ¼ã‚¯ãƒ³ã®ç™ºè¡Œã¯å¯èƒ½ã§ã‚ã‚‹ã€‚ãŸã ã—ã€Twitterã®APIã‚’æ‚ªç”¨ã™ã‚‹è€…ãŒå¤šã„ã‹ã‚‰ã‹ã€ä½œæˆã™ã‚‹ã‚¢ãƒ—ãƒªã®æ¦‚è¦ã€ã©ã‚“ãªã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’å©ãã‹ãªã©ã‚’è‹±èªã§ä½œæ–‡ã—ã€Twitterã®å¯©æŸ»ã‚’å—ã‘ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚ç§ã‚‚é ‘å¼µã£ã¦è‹±èªã§ä½œã‚ŠãŸã„ã‚‚ã®ã‚’èª¬æ˜ã—ãŸãŒã€ã‚‚ã£ã¨è©³ã—ãæ•™ãˆã¦æ¬²ã—ã„ã¨ã®æ—¨ã®ãƒ¡ãƒ¼ãƒ«ã‚’å—ã‘å–ã£ã¦ã„ã‚‹...

ãã®ãƒ¡ãƒ¼ãƒ«ãŒGoogleç¿»è¨³ã§è‡ªå‹•çš„ã«æ—¥æœ¬èªã«ãªã£ã¦ã„ãŸã®ã‹ã€è¿”ä¿¡ã‚’æ—¥æœ¬èªã§è¿”ã—ãŸã‚‰å†åº¦åŒã˜ãƒ¡ãƒ¼ãƒ«ã‚’ã‚‚ã‚‰ã†ã€ã¨ã„ã†ã“ã¨ã‚‚ã‚„ã‚‰ã‹ã—ã¦ã„ãŸã®ã§ã€ã‚¢ãƒ—ãƒªãŒæ‰¿èªã•ã‚Œã‚‹ã¾ã§æ™‚é–“ãŒã‹ã‹ã£ã¦ã—ã¾ã£ãŸã€‚

æœ€çµ‚çš„ã«ä»¥ä¸‹ã®ã‚ˆã†ã«ã€ãŸã æ¯æ—¥00:10ã«æ±ºã¾ã£ãŸãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ãƒ„ã‚¤ãƒ¼ãƒˆã‚’ã—ãŸã„ã ã‘ãªã‚“ã ã€ã¨ã„ã†ãƒ¡ãƒ¼ãƒ«ã‚’é€ã‚Šã¤ã‘ãŸã“ã¨ã«ã‚ˆã‚Šã€ã‚¢ãƒ—ãƒªã¯æ‰¿èªã•ã‚ŒãŸã€‚

```
Post to your own (@ myblackcat7112) account once a day, the result of hitting the Fitbit API to check your exercise habits, formatted as follows:

Today's exercise from fitbit
Sitting time: 662 minutes
Light exercise time: 127 minutes
Active exercise time: 49 minutes
Time for strenuous exercise: 78 minutes
Today's steps: 8650 steps (5.893km)
Basal metabolism: 1402 kcal
Calories burned: 2727 kcal

https://twitter.com/myblackcat7112/status/1377597776662470657?s=20

I will post to my account, @myblackcat7112  at 00:10:00 everydays.
I want to use the API to post an auto-generated message to Twitter.
```

ã“ã®æ‰¿èªã‚’å¾—ã‚‹ä½œæ¥­ãŒã€ä»Šå›ã€æœ€ã‚‚é›£ã—ã‹ã£ãŸã¨è¨€ã£ã¦ã‚‚éè¨€ã˜ã‚ƒãªã„ç¬‘

> fitbitã®APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã¨ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³(æœŸé™ãŒã‚ã‚‹)ã‚’å–å¾—ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

ã«é–¢ã—ã¦ã¯ã€ä¸Šè¿°ã—ãŸ`OAuth 2.0 tutorial page`ã§ç°¡å˜ã«å–å¾—ã§ãã‚‹ã®ã§å•é¡Œãªã„ã€‚

![å®Ÿéš›ã®èªå¯å–å¾—ç”»é¢ã®URLã‚’ç”Ÿæˆã™ã‚‹ãƒšãƒ¼ã‚¸](/images/uploaded/20210524-004054.png)

è©³ç´°ã«é–¢ã—ã¦ã¯ã“ã¡ã‚‰ã®è¨˜äº‹ã‚‚å‚è€ƒã«ãªã‚‹ã¨æ€ã†ã€‚

[Pythonã§fitbit APIã‹ã‚‰å¿ƒæ‹æ•°ã‚’å–å¾—ã—ã¦ã¿ã‚ˆã†ï¼](https://qiita.com/fujit33/items/2af7c4afdb4e07601def)

> 3. fitbitã®APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å®šæœŸçš„ã«æ›´æ–°ã™ã‚‹ä»•çµ„ã¿ãŒã‚ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚
> 4. å®šæœŸçš„ã«fitbitAPIã‚’å©ã„ã¦å–å¾—ã—ãŸå€¤ã‚’ç”¨ã„ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ç”Ÿæˆã—ã€Twitterã«æŠ•ç¨¿ã™ã‚‹ä»•çµ„ã¿ãŒå¿…è¦ã«ãªã‚‹ã€‚

ã«é–¢ã—ã¦ã¯å°‘ã—ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ãå¿…è¦ãŒã‚ã‚‹ã€‚ä»Šå›ã¯AWS ã®Lambdaã‚’ç”¨ã„ã¦ã€Tweetã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

ã¾ãŸã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ã¯ã€AWSã®Secret Managerã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã€Tweetã‚’å®Ÿè¡Œã™ã‚‹å‰ã®ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«æ›´æ–°ã™ã‚‹Lambdaã‚’å®Ÿè¡Œã™ã‚‹ã“ã¨ã§è§£æ±ºã™ã‚‹ã“ã¨ã«ã—ãŸã€‚

## Secret Manager ? 

[AWSã®Secret Manager](https://ap-northeast-1.console.aws.amazon.com/secretsmanager) ã¯ DBã®èªè¨¼æƒ…å ±ã‚„APIã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã‚’å®‰å…¨ã«ä¿ç®¡ã—ã¦ãŠãã“ã¨ãŒã§ãã‚‹ã‚‚ã®ã§ã‚ã‚‹ã€‚

>ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚ãŸã‚Š $0.40 / æœˆ

>10,000 å›ã® API ã‚³ãƒ¼ãƒ«ã‚ãŸã‚Š $0.05

ã¨ã‚ã‚‹ã®ã§ã€ã‚ã¾ã‚Šå¤šãã‚’ä¿å­˜ã™ã‚‹ã®ã¯ã‚³ã‚¹ãƒˆãŒå¢—ãˆã‚‹ã ã‘ã§ã¯ã‚ã‚‹ãŒã€è³¢ãä½¿ãˆã°èªè¨¼æƒ…å ±ã‚’å®‰å…¨ã«ä¿ç®¡ã—ãŸã‚Šã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã®ãƒ­ãƒ¼ãƒ†ã‚·ãƒ§ãƒ³(è‡ªå‹•æ›´æ–°)ãŒã§ãã‚‹ã‚‚ã®ã§ã‚ã‚‹ã€‚

ä»Šå›ã¯ã€TwitterAPIã¨FitbitAPIã®APIæƒ…å ±ã‚’æ ¼ç´ã™ã‚‹ã“ã¨ã«ã™ã‚‹ã€‚

ä½¿ã„æ–¹ã¯ç°¡å˜ã§ã€ä¿å­˜ã—ãŸã„å€¤ã®åå‰(key)ã¨å€¤(value)ã‚’ä¿å­˜ã™ã‚‹ã ã‘ã§ã‚ã‚‹ã€‚ãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã¯ã€SecretManagerã®æ›´æ–°æ¨©é™ã‚’ã€æŒã¡å®Ÿéš›ã«æ›´æ–°ã™ã‚‹å‡¦ç†ãŒæ›¸ã‹ã‚Œã¦ã„ã‚‹AWS Lambdaã‚’æŒ‡å®šã—ã¦ã‚ã’ã‚‹ã“ã¨ã§å¯èƒ½ã«ãªã‚‹ã€‚(ä¸€å¿œè¨­å®šã—ã¦ã‚ã‚‹ãŒã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®å•é¡Œã‹ã‚ã¾ã‚Šã†ã¾ãã„ã£ã¦ã„ãªã„ã®ã§ã€ã“ã“ã§è¨­å®šã—ã¦ã„ã‚‹Lambdaã‚’å®šæœŸå®Ÿè¡Œã™ã‚‹ã¨ã„ã†ã ã•ã„ã“ã¨ã‚’ã‚„ã£ã¦ã—ã¾ã£ã¦ã„ã‚‹...)

![SecretManagerã®ç”»é¢](/images/uploaded/20210524-010102.png)

![ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®šç”»é¢](/images/uploaded/20210524-010605.png)

SecretManagerã‹ã‚‰Lambdaã‚’å‘¼ã³å‡ºã™ã®ã«ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¨­å®šã‚’ç”»é¢ã‹ã‚‰è¡Œãªã£ãŸãŒã†ã¾ãã„ã‹ãªã‹ã£ãŸã€‚(åŸå› ã¯ã„ã¾ã ã«ã‚ˆãã‚ã‹ã‚‰ãªã„ãŒã€æ¨©é™ãŒè¶³ã‚‰ãªã‹ã£ãŸã®ã‹ã‚‚ã—ã‚Œãªã„ï¼Ÿ)

```
"Statement": [
    {
      "Sid": "SecretsManagerAccess",
      "Effect": "Allow",
      "Principal": {
        "Service": "secretsmanager.amazonaws.com"
      },
      "Action": "lambda:InvokeFunction",
      "Resource": "arn:aws:lambda:ap-northeast-1:XXXXXXX:function:fitbit-api-token-refresh"
    },
```

çµå±€ã€[AWS Secrets Manager ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã«é–¢ã™ã‚‹ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°](https://docs.aws.amazon.com/ja_jp/secretsmanager/latest/userguide/troubleshoot_rotation.html)ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’è¨­å®šã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€Œã‚¢ã‚¯ã‚»ã‚¹æ‹’å¦ã€ãŒç™ºç”Ÿã™ã‚‹ã®éƒ¨åˆ†ã«æ›¸ã‹ã‚Œã¦ã„ãŸã‚³ãƒãƒ³ãƒ‰ã‚’å®Ÿè¡Œã—ãŸã‚‰ä¸€ç™ºã§è§£æ±ºã—ãŸã€‚ 

```
aws lambda add-permission --function-name ARN_of_lambda_function --principal secretsmanager.amazonaws.com --action lambda:InvokeFunction --statement-id SecretsManagerAccess
```

## ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ›´æ–°ã™ã‚‹ãŸã‚ã«å®Ÿè£…ã—ãŸLambda

```python
import json
import requests
from datetime import datetime, timezone, timedelta
from SecretManager import SecretManager

def lambda_handler(event, context):
    sm = SecretManager('Fitbit')
    secret = sm.get()
    headers = {
        'Authorization':'Basic '+secret['BASIC_TOKEN'],
        'Content-Type':'application/x-www-form-urlencoded'
    }
    data = {
        'grant_type':'refresh_token',
        'refresh_token':secret['REFRESH_TOKEN']
    }
    response = requests.post(
        'https://api.fitbit.com/oauth2/token', 
        headers = headers, 
        data = data
    )
    params = json.loads(response.content)
    secrets = {
        'BASIC_TOKEN': secret['BASIC_TOKEN'],
        'CLIENT_ID': secret['CLIENT_ID'],
        'CLIENT_SECRET': secret['CLIENT_SECRET'],
        'ACCESS_TOKEN': params['access_token'],
        'REFRESH_TOKEN': params['refresh_token'],
        'UPDATED': datetime.now(timezone(timedelta(hours=9))).strftime('%Y/%m/%d %H:%M:%S'),
    }
    sm.update(secrets)
    
    return {
        'statusCode': 200,
        'body': 'update!!'
    }
```

Lambdaã§ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¯ã€å¤§ããåˆ†ã‘ã¦2ã¤ã€‚

1. SecretManagerã«ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ“ä½œ(å–å¾—ã¨æ›´æ–°)
2. fitbit APIã®èªè¨¼ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã«ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’postã—ã¦ã€æ–°ãŸãªã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã€ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—ã™ã‚‹

SecretManager classã¯ã€SecretManagerã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’ã‚‚ã¨ã«å‡¦ç†ã‚’classã«ã¾ã¨ã‚ãŸã ã‘ã®ã‚‚ã®ã§åˆ¥ã«ç‰¹ç­†ã™ã‚‹ã‚‚ã®ã§ã¯ãªã„ãŒä¸€å¿œã‚³ãƒ¼ãƒ‰ã‚’æ®‹ã—ã¦ãŠã“ã†ã¨æ€ã†ã€‚[boto3](https://aws.amazon.com/jp/sdk-for-python/)ã¨ã„ã†AWSæ“ä½œã®ãŸã‚ã®Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ä½¿ç”¨ã—ã¦ã„ã‚‹ã€‚

```python
from botocore.exceptions import ClientError
import base64
import boto3
import json

class SecretManager:
    
    def __init__(self, secret_name, region_name = 'ap-northeast-1'):
        self.region_name = region_name
        self.secret_name = secret_name
        self.client = self.get_client()

    # secret manager client
    def get_client(self):
        # Create a Secrets Manager client
        session = boto3.session.Session()
        client = session.client(
            service_name = 'secretsmanager',
            region_name = self.region_name
        )
        return client
    
    # secret manager ãƒˆãƒ¼ã‚¯ãƒ³æ›´æ–°
    def update(self, update_json):
        try:
            return self.client.update_secret(
                SecretId = self.secret_name, 
                SecretString = json.dumps(update_json)
            )
        except ClientError as e:
            print(e)
    
    # Secrets Managerã®ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ã‚’å‚è€ƒã«
    def get(self):
        try:
            get_secret_value_response = self.client.get_secret_value(
                SecretId=self.secret_name
            )   
        except ClientError as e:
            print(e)
            if e.response['Error']['Code'] == 'DecryptionFailureException':
                # Secrets Manager can't decrypt the protected secret text using the provided KMS key.
                # Deal with the exception here, and/or rethrow at your discretion.
                raise e
            elif e.response['Error']['Code'] == 'InternalServiceErrorException':
                # An error occurred on the server side.
                # Deal with the exception here, and/or rethrow at your discretion.
                raise e
            elif e.response['Error']['Code'] == 'InvalidParameterException':
                # You provided an invalid value for a parameter.
                # Deal with the exception here, and/or rethrow at your discretion.
                raise e
            elif e.response['Error']['Code'] == 'InvalidRequestException':
                # You provided a parameter value that is not valid for the current state of the resource.
                # Deal with the exception here, and/or rethrow at your discretion.
                raise e
            elif e.response['Error']['Code'] == 'ResourceNotFoundException':
                # We can't find the resource that you asked for.
                # Deal with the exception here, and/or rethrow at your discretion.
                raise e
        else:
            # Decrypts secret using the associated KMS CMK.
            # Depending on whether the secret is a string or binary, one of these fields will be populated.
            if 'SecretString' in get_secret_value_response:
                secret = get_secret_value_response['SecretString']
                return json.loads(secret)
            decoded_binary_secret = base64.b64decode(get_secret_value_response['SecretBinary'])
            return json.loads(decoded_binary_secret)
```

## å®Ÿéš›ã«Tweetã™ã‚‹ã®ã«å®Ÿè£…ã—ãŸLambda

```python
import json
from Twitter import Twitter
from Fitbit import Fitbit

def lambda_handler(event, context):

    results = {}
    fitbit = Fitbit()
    for resource in fitbit.get_resources():
        data = fitbit.intraday_time_series(resource)
        print(data)
        results[list(data.keys())[0]] = list(data.values())[0][0]['value']
    results['datetime'] = list(data.values())[0][0]['dateTime']
    
    distances = float(results['activities-tracker-distance']) * 1.61

    message =  f"æœ¬æ—¥({results['datetime']})ã®é‹å‹• from Fitbit\n\n"
    message += f"åº§ã£ã¦ã„ãŸæ™‚é–“: {results['activities-tracker-minutesSedentary']}åˆ†\n"
    message += f"è»½ã„é‹å‹•ã®æ™‚é–“: {results['activities-tracker-minutesLightlyActive']}åˆ†\n"
    message += f"ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªé‹å‹•ã®æ™‚é–“: {results['activities-tracker-minutesFairlyActive']}åˆ†\n"
    message += f"æ¿€ã—ã„é‹å‹•ã®æ™‚é–“: {results['activities-tracker-minutesVeryActive']}åˆ†\n\n"
    message += f"æœ¬æ—¥ã®æ­©æ•°: {results['activities-tracker-steps']}æ­© ({distances:.3f}km)\n\n"
    message += f"æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼: {results['activities-tracker-calories']}kcal ("
    message += f"åŸºç¤ä»£è¬: {results['activities-caloriesBMR']}kcal)"
    print(message)
    
    sleep = fitbit.sleep()['summary']
    sleep_message = f"æœ¬æ—¥({results['datetime']})ã®ç¡çœ æ™‚é–“ from Fitbit\n\n"
    sleep_message += f"ç¡çœ æ™‚é–“: {sleep['totalMinutesAsleep']/60 :.3f}æ™‚é–“"
    print(sleep_message)

    # twitterã¸ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ•ç¨¿ã™ã‚‹
    twitter = Twitter()
    twitter.status_update(message)
    twitter.status_update(sleep_message)
    
    return {
        'statusCode': 200,
        'body': json.dumps(results)
    }

```

ä»Šå›Fitbit APIã§å–å¾—ã™ã‚‹å¯¾è±¡ã¯ã€ä»¥ä¸‹ã®ã‚‚ã®ã§ã‚ã‚Šã€ã“ã‚Œã‚‰ã®ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‹ã‚‰æƒ…å ±ã‚’å–å¾—ã™ã‚‹éƒ¨åˆ†ã¯ã€[fitbitã®Pythonãƒ©ã‚¤ãƒ–ãƒ©ãƒª](https://python-fitbit.readthedocs.io/en/latest/)ã‚’ç”¨ã„ã¦ã„ã‚‹ã€‚
[Activity & Exercise Logs](https://dev.fitbit.com/build/reference/web-api/activity/)ã«å®šç¾©ã•ã‚Œã¦ã„ã‚‹resourceã‚’
```
intraday_time_series(resource, base_date='today', detail_level='1min', start_time=None, end_time=None)
```
ã«æŒ‡å®šã—ã¦ã‚ã’ã‚‹ã¨ã€ãã®æƒ…å ±ã‚’1æ—¥ã®ã‚µãƒãƒªãƒ¼ã‚’å–å¾—ã—ã¦ãã‚Œã‚‹ã€‚

ãŸã ã—ã€ã“ã‚ŒãŒå®Ÿè¡Œã•ã‚Œã‚‹ã®ã¯æ—¥ä»˜ãŒå¤‰ã‚ã£ã¦ã‹ã‚‰ãªã®ã§ã€å®Ÿéš›ã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«å‰æ—¥ã®æ—¥ä»˜ã§å–å¾—ã—ã¦ã„ã‚‹ã€‚

```python
    # å‰æ—¥ã®ã‚µãƒãƒªãƒ¼ã‚’å–å¾—ã—ãŸã„ã®ã§ã€‚
    def intraday_time_series(self, resource):
        yesterday = datetime.now(timezone(timedelta(hours=9))) - timedelta(days=1)
        return self.client.intraday_time_series(resource, base_date = yesterday)
```

```python
    # å–å¾—å¯¾è±¡
    RESOURCES = [
        'activities/caloriesBMR',
        'activities/tracker/calories',
        'activities/tracker/steps',
        'activities/tracker/distance',
        'activities/tracker/minutesSedentary',
        'activities/tracker/minutesLightlyActive',
        'activities/tracker/minutesFairlyActive',
        'activities/tracker/minutesVeryActive',
        'activities/tracker/activityCalories',
    ]
```
cloud watchã«åãå‡ºã•ã‚Œã¦ã„ã‚‹å®Ÿéš›ã®ãƒ­ã‚°ã€‚åŠ å·¥ãŒå¿…è¦ãªã®ã¯ç§»å‹•è·é›¢ãã‚‰ã„ã§ãã‚Œä»¥å¤–ã¯ãã®ã¾ã¾å‡ºåŠ›ã—ã¦ã‚‚å•é¡Œãªã„å€¤ã«ãªã£ã¦ã„ã‚‹ã€‚
```
{'activities-caloriesBMR': [{'dateTime': '2021-05-23', 'value': '1560'}]}
{'activities-tracker-calories': [{'dateTime': '2021-05-23', 'value': '1988'}]}
{'activities-tracker-steps': [{'dateTime': '2021-05-23', 'value': '1781'}]}
{'activities-tracker-distance': [{'dateTime': '2021-05-23', 'value': '0.75363626392912'}]}
{'activities-tracker-minutesSedentary': [{'dateTime': '2021-05-23', 'value': '551'}]}
{'activities-tracker-minutesLightlyActive': [{'dateTime': '2021-05-23', 'value': '90'}]}
{'activities-tracker-minutesFairlyActive': [{'dateTime': '2021-05-23', 'value': '4'}]}
{'activities-tracker-minutesVeryActive': [{'dateTime': '2021-05-23', 'value': '7'}]}
{'activities-tracker-activityCalories': [{'dateTime': '2021-05-23', 'value': '441'}]}

```
ä¸Šè¿°ã—ãŸãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ç”Ÿæˆã•ã‚ŒãŸå®Ÿéš›ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã€‚
```
æœ¬æ—¥(2021-05-23)ã®é‹å‹• from Fitbit
åº§ã£ã¦ã„ãŸæ™‚é–“: 551åˆ†
è»½ã„é‹å‹•ã®æ™‚é–“: 90åˆ†
ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªé‹å‹•ã®æ™‚é–“: 4åˆ†
æ¿€ã—ã„é‹å‹•ã®æ™‚é–“: 7åˆ†
æœ¬æ—¥ã®æ­©æ•°: 1781æ­© (1.213km)
æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼: 1988kcal (åŸºç¤ä»£è¬: 1560kcal)
```

ç¡çœ æƒ…å ±ã«é–¢ã—ã¦ã¯ã€sleep()ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å‘¼ã³å‡ºã—ã¦ã„ã‚‹ã€‚

```
æœ¬æ—¥(2021-05-23)ã®ç¡çœ æ™‚é–“ from Fitbit
ç¡çœ æ™‚é–“: 12.433æ™‚é–“
```

ã‚ã¨ã¯ã“ã®Lambdaã‚’Event Bridge(Cloud watch Events)ã§ã€ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ãŒçµ‚ã‚ã£ãŸã§ã‚ã‚ã†ã€00:20ã«å‘¼ã³å‡ºã—ã¦ã‚ã’ã‚Œã°æ™´ã‚Œã¦ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ„ã‚¤ãƒ¼ãƒˆãŒã•ã‚Œã‚‹ã¨ã„ã†ã‚ã‘ã§ã‚ã‚‹ã€‚

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">æœ¬æ—¥(2021-05-23)ã®é‹å‹• from Fitbit<br><br>åº§ã£ã¦ã„ãŸæ™‚é–“: 551åˆ†<br>è»½ã„é‹å‹•ã®æ™‚é–“: 90åˆ†<br>ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªé‹å‹•ã®æ™‚é–“: 4åˆ†<br>æ¿€ã—ã„é‹å‹•ã®æ™‚é–“: 7åˆ†<br><br>æœ¬æ—¥ã®æ­©æ•°: 1781æ­© (1.213km)<br><br>æ¶ˆè²»ã‚«ãƒ­ãƒªãƒ¼: 1988kcal (åŸºç¤ä»£è¬: 1560kcal)</p>&mdash; BlackcatğŸŒ” (@myblackcat7112) <a href="https://twitter.com/myblackcat7112/status/1396486255504805888?ref_src=twsrc%5Etfw">May 23, 2021</a></blockquote>

<blockquote class="twitter-tweet"><p lang="ja" dir="ltr">æœ¬æ—¥(2021-05-23)ã®ç¡çœ æ™‚é–“ from Fitbit<br><br>ç¡çœ æ™‚é–“: 12.433æ™‚é–“</p>&mdash; BlackcatğŸŒ” (@myblackcat7112) <a href="https://twitter.com/myblackcat7112/status/1396486256725430277?ref_src=twsrc%5Etfw">May 23, 2021</a></blockquote>

ã“ã“ã¾ã§ã®ã‚³ãƒ¼ãƒ‰ã¯ã€[ã“ã“](https://github.com/kuroneko913/fitbit-notifier)ã«ã™ã¹ã¦ã¾ã¨ã‚ã¦ã‚ã‚Šã¾ã™ã€‚

## ã¾ã¨ã‚
Fitbit + Lambda + SecretManager + Twitter ã§ã€å¥åº·çŠ¶æ³ã‚’å¸¸ã«æ„è­˜ã™ã‚‹ç’°å¢ƒã‚’æ•´ãˆãŸã€‚
(ã“ã®å ±å‘Šã‚’æ·±å¤œ2æ™‚ã«æ›¸ã„ã¦ã„ã‚‹æ™‚ç‚¹ã§ã€ç¡çœ ä¸è¶³ã¯å¿…è‡³ãªã®ã ãŒ...)

ä»Šå¾Œã¯ã€ã“ã®å€¤ã®å¹³å‡å€¤ãªã©ãŒä¸€å®šã®é–¾å€¤ã‚’ä¸‹å›ã£ãŸã‚Šã€ä¸Šå›ã£ãŸã‚Šã—ãŸæ™‚ã«ã‚‚é€šçŸ¥ãŒé£›ã°ã›ã‚‹ã‚ˆã†ã«ãªã‚Œã°ã€ã‚¢ãƒ©ãƒ¼ãƒˆã¨ã—ã¦ã‚‚ä½¿ãˆã‚‹ã‚ˆã†ãªæ°—ãŒã™ã‚‹ã€‚SREã®å‹‰å¼·ä¼šã§èª­ã‚“ã ã€[å…¥é–€ç›£è¦–](https://www.amazon.co.jp/%E5%85%A5%E9%96%80-%E7%9B%A3%E8%A6%96-%E2%80%95%E3%83%A2%E3%83%80%E3%83%B3%E3%81%AA%E3%83%A2%E3%83%8B%E3%82%BF%E3%83%AA%E3%83%B3%E3%82%B0%E3%81%AE%E3%81%9F%E3%82%81%E3%81%AE%E3%83%87%E3%82%B6%E3%82%A4%E3%83%B3%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-Mike-Julian/dp/4873118646)ã‚’å†åº¦èª­ã¿ç›´ã—ã¦ã€ç”Ÿã‹ã—ã¦ã¿ã‚‹ã®ã‚‚ã„ã„ã®ã‹ã‚‚ã—ã‚Œãªã„ã€‚